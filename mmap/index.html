<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8" />
	<title> Marauder's Map </title>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
	<link rel="stylesheet" href="mingmap.css" />
	
	<script type="text/javascript">

		var infowindow = new google.maps.InfoWindow();
		var myLat = 0;
		var myLng = 0;
		var orgin = new google.maps.LatLng(myLat, myLng);
		
		// Set up Google Map
		var mapOptions = {
	        zoom: 10,
	        center: orgin,
	        mapTypeId: google.maps.MapTypeId.ROADMAP
	    };

		// Create the map_canvas
	    var map; 

	    function init(){

	    	map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);

	    	console.log("1. In init before geolocation");

	    	if(navigator.geolocation){
	    	//google maps has been approved to see your location		
	    		navigator.geolocation.getCurrentPosition(function(position){
	    			console.log("2. Got your location");
	    			//set my position
	    			myLat = position.coords.latitude;
	    			myLng = position.coords.longitude;
					
					console.log("Before map");
	    			
	    			//center the map to my location
	    			var me = new google.maps.LatLng(myLat, myLng);
	    			map.panTo(me);

	        		// Create request to send geolocation information  
	    			request = new XMLHttpRequest();

	    			params = "login=SheriHeller&lat=" + myLat + "&lng=" + myLng;

	    			request.open("POST", "https://secret-about-box.herokuapp.com/sendLocation", true);

	    			request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

	    			request.onreadystatechange = parseData;
			
	    			request.send(params);

	    			//mymap(myLat, myLng);
	    			console.log("3. Leaving the getCurrentPosition function");
	    		});
	    	}
	    	console.log("4. Leaving init()");

	    }


	    function parseData() {
	    	
	    	otherLat = 0;
	    	otherLng = 0;
	    	username = "empty";

	    	console.log("In parseData()");
	    	if (request.readyState == 4){
	    		console.log("In parseData() --YAY!");
	    		console.log(request.responseText);

	    		var converted = JSON.parse(request.responseText);
	    		console.log(converted);
	    		
	    		for (i =0; i < converted.length; i++){
	    			otherLat = converted[i]["lat"];
	    			otherLng = converted[i]["lng"];
	    			username = converted[i]["login"];
	    			var other = new google.maps.LatLng(otherLat, otherLng);
	    			
	    			// Create a marker
	    			var marker = new google.maps.Marker({
	        			position: other,
	        			title: username
	        		});

	    			//place marker on map
	    			marker.setMap(map);	

					// Create info window
	        		google.maps.event.addListener(marker, 'click', function(){
	        			infowindow.setContent(marker.title);
	        			infowindow.open(map, marker);
	        		});
	    		}
	    	}
	    }




	
	  	

	</script>
	
	</head>

	<body onload = "init()">
           
    <div id="map_canvas"></div>


	</body>

</html>
